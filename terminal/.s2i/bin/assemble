#!/bin/bash

set -x

set -eo pipefail

# Override PATH for the assemble script so that /usr/bin precedes
# /opt/app-root/bin so wrong Python version isn't found during setup
# if using Python S2I base image.

PATH=/usr/bin:$PATH

# Override HOME directory for the assemble script so that per user
# files are not installed under /opt/app-root/src. This means that
# the per user Python area is located under /opt/app-root/.local.

HOME=/opt/app-root

# Install pip for Python 2.7.

curl -s -o /tmp/get-pip.py https://bootstrap.pypa.io/get-pip.py

/usr/bin/python /tmp/get-pip.py --user

rm -f /tmp/get-pip.py

# Install virtualenv for Python 2.7.

/opt/app-root/.local/bin/pip install --no-cache-dir --user virtualenv

# Create a virtual environment for Python 2.7.

/opt/app-root/.local/bin/virtualenv /opt/app-root/butterfly

# Install butterfly into the virtual environment.

source /opt/app-root/butterfly/bin/activate

pip install git+https://github.com/GrahamDumpleton/butterfly@uri-root-path#egg=butterfly

# Download and install oc client application.

curl -s -o /tmp/oc.tar.gz "$OC_CLIENT_URL"

tar -C /opt/app-root/bin -zxvf /tmp/oc.tar.gz oc

rm /tmp/oc.tar.gz

# This S2I assemble script is only used when creating the custom image.
# For when running the image, or using it as a S2I builder, we use a second
# set of custom S2I scripts. We now need to move these into the correct
# location and have the custom image use those by dropping in an image
# metadata file which overrides the labels of the base image.

mkdir -p /tmp/.s2i

mv /tmp/src/builder/image_metadata.json /tmp/.s2i/image_metadata.json

mv /tmp/src/builder /opt/app-root/builder

mv /tmp/src/*.sh /opt/app-root/bin

# Ensure passwd/group file intercept happens for any shell environment.

if [ -f /opt/app-root/etc/generate_container_user ]; then
    echo "source /opt/app-root/etc/generate_container_user" >> /opt/app-root/etc/scl_enable
fi

# Create additional directories.

mkdir -p /opt/app-root/data

# Make sure the S2I source directory is empty as we will use the image
# produced to run further S2I builds.

rm -rf /tmp/src

# Fixup permissions on directories and files.

fix-permissions /opt/app-root
